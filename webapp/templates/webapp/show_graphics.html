{% load staticfiles %}
<html>
<head>	
	<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>Modelo de Simulación de Cultivos </title>
	
	<!--JQuery-->	
	<script src="{% static 'lib/jquery-3.1.0/jquery-3.1.0.min.js' %}"></script>
	
	<!--Boostrap-->
	<link rel="stylesheet" href="{% static 'lib/bootstrap-3.3.7/css/bootstrap.min.css' %}">
	<link rel="stylesheet" href="{% static 'lib/bootstrap-3.3.7/css/bootstrap-theme.min.css' %}">	
	<script src="{% static 'lib/bootstrap-3.3.7/js/bootstrap.min.js' %}"></script>
	
	<!--Simulacion-->
	<link rel="stylesheet" href="{% static 'css/style.css' %}">
	<script type="text/javascript" src="{% static 'js/scriptEstilos.js' %}"></script>
	
	
	<!--Pasar estos si se usan local-->
	<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="{% static 'lib/bootstrap-datetimepicker-0.0.11/css/bootstrap-datetimepicker.min.css' %}">	
	<script type="text/javascript" src="{% static 'lib/bootstrap-datetimepicker-0.0.11/js/bootstrap-datetimepicker.min.js' %}"> </script>	
	<script type="text/javascript" src="{% static 'lib/bootstrap-datetimepicker-0.0.11/js/bootstrap-datetimepicker.pt-BR.js' %}">  </script>
	<script type="text/javascript" src="{% static 'lib/jquery-validation-1.15.0/jquery.validate.min.js' %}">  </script>

	<script>
		
		var escenarios = [];						
		var suelos = [];
		var riegos = [];
		var cultivos = [];
		//listMean,listMediana,listWhiskerxsenor,listWhiskerxsayor,listBase,listMayor
		
		function cargarDatos(){			
			count = 0;
			datosNumericos = {{ resultPlot }};							
			
			get = window.location.search.replace("?", "");
			getListParametros = get.split("&");
			console.log(getListParametros);
			
			{% for nomE in nombreEscenarios %}

				escenario = {
					nombre: "{{ nomE }}",
					promedio: datosNumericos[0][count],
					mediana: datosNumericos[1][count],
					whiskMenor: datosNumericos[2][count],
					whiskMayor: datosNumericos[3][count],
					base: datosNumericos[4][count], 
					mayor: datosNumericos[5][count],
					estMeteorologica: getListParametros[count*17+0].split("=")[1],
					fInicioSim: getListParametros[count*17+1].split("=")[1],
					fFinSim: getListParametros[count*17+2].split("=")[1],
					cultivo: getListParametros[count*17+3].split("=")[1],
					cultivoTSuelo: getListParametros[count*17+4].split("=")[1],
					cultivoTCultivar: getListParametros[count*17+5].split("=")[1],
					cultivoNHumedad: getListParametros[count*17+6].split("=")[1],
					cultivoNO3: getListParametros[count*17+7].split("=")[1],
					cultivoFSiembra: getListParametros[count*17+8].split("=")[1],
					fertilizacionSiembraDias: getListParametros[count*17+9].split("=")[1],
					fertilizacionSiembraCantidad: getListParametros[count*17+10].split("=")[1],
					fertilizacion1Dias: getListParametros[count*17+11].split("=")[1],
					fertilizacion1Cantidad: getListParametros[count*17+12].split("=")[1],
					fertilizacion2Dias: getListParametros[count*17+13].split("=")[1],
					fertilizacion2Cantidad: getListParametros[count*17+14].split("=")[1],
					riego: getListParametros[count*17+15].split("=")[1]					
				};		
				escenarios.push(escenario);
				count = count + 1;
			{% endfor %}
		};		
		
		function cargarParrafos(){										
			for (i = 0; i < escenarios.length; i++) { 						
				var para = document.createElement("P");
				var paraCE = document.createElement("P");

				var textoCE = "Para el escenario " + escenarios[i].nombre + " hay una probabilidad de 50% de obtener rindes por encima de "+escenarios[i].mediana+"Kg/ha. Por otro lado, 3 de cada 4 años se obtienen rindes por encima de "+escenarios[i].base+"Kg/ha, la probabilidad es de 75%, y una vez cada 4 años rindes por encima de "+escenarios[i].mayor + "Kg/ha (25%).";
				var texto = "El gráfico muestra que en el escenario " + escenarios[i].nombre + " hay un 50% de chances de que el rendimiento esté entre " + escenarios[i].whiskMenor +" y "+ escenarios[i].whiskMayor +" Kg/ha (límites de la “Caja”). Por otro lado la chance de obtener "+escenarios[i].mediana+" Kg/ha o más es de 50%, es decir se puede esperar que en la mitad de los años el rendimiento sea por lo menos "+escenarios[i].mediana+" Kg/ha.  La probabilidad de obtener " + escenarios[i].whiskMenor +" Kg/ha o menos es de 25%, es decir una vez cada 4 años se pueden esperar rendimientos menores a "+escenarios[i].whiskMenor+" Kg/ha. Lo mismo sucede con rendimientos superiores a " +escenarios[i].whiskMayor+" Kg/ha.";								
				var t = document.createTextNode(texto);  
				var tCE = document.createTextNode(textoCE);       				
				para.appendChild(t);  
				paraCE.appendChild(tCE);				
				document.getElementById("datosBoxplot").appendChild(para); 
				document.getElementById("datosCurvaExedencia").appendChild(paraCE);				
			}					
		};
		
		function etiquetaCultivo(c){
			for (var l = 0;l<cultivos.length;l++){
				if (c===cultivos[l].valor){
					return cultivos[l].nombre;
				}
			}
		};
		
		function etiquetaSuelo(s){			
			for (var l = 0;l<suelos.length;l++){
				if (s===suelos[l].valor){
					return suelos[l].etiqueta;
				}
			}
		};
		
		function etiquetaRiego(r){
			var rieg = "";
			if (r=='0'){
				rieg = "No";
			}else{
				rieg = "Automático";
			}
			return rieg;
		};
		
		function cargarEscenarios(){
			var table = document.getElementById("tEscenarios");						
						
			for (i=0;i<escenarios.length;i++){
				var row = table.insertRow(i+1);

				// Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				var cell4 = row.insertCell(3);
				var cell5 = row.insertCell(4);
				

				// Add some text to the new cells:
				cell1.innerHTML = escenarios[i].nombre;
				cell2.innerHTML = etiquetaCultivo(escenarios[i].cultivo);
				cell3.innerHTML = etiquetaSuelo(escenarios[i].cultivoTCultivar);
				cell4.innerHTML = etiquetaRiego(escenarios[i].riego);
				console.log(escenarios[i]);
				cell5.innerHTML = "<button class='btn btn-primary' onclick='setearCookie("+i+")'>Modificar</button>";			
			}

			if (escenarios.length<5){
				var row = table.insertRow(escenarios.length+1);
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				var cell4 = row.insertCell(3);
				var cell5 = row.insertCell(4);
				cell1.innerHTML = "";
				cell2.innerHTML = "";
				cell3.innerHTML = "";
				cell4.innerHTML = "";				
				cell5.innerHTML = "<button class='btn btn-primary' onclick='agregarNuevoEscenario()'>Agregar escenario</button>";	
				
			}
		};

		function agregarNuevoEscenario(){
			setearCookie('NuevoEscenario');
		};
		
		function setearCookie(esc){
			console.log(esc);	
			//document.cookie = escenarios[esc];						
			var cookie = ['escenarios', '=', JSON.stringify(escenarios),'; domain=', "127.0.0.1", '; path=/;'].join('');					
			document.cookie = cookie;
			window.location = "http://127.0.0.1:8000/webapp/?modificar="+ esc;
		};			
		
		function read_cookie() {
			var result = document.cookie.match(new RegExp('escenarios' + '=([^;]+)'));
			result && (result = JSON.parse(result[1]));
			return result;
		};
								
		function cargarTSuelos(){
			{% for cultivo in cultivos %}
				var c = {
					nombre: "{{ cultivo.nombre }}",					
					valor:"{{ cultivo.value }}"
				};
				cultivos.push(c);
				{% for s in cultivo.tipo_cultivares.all %}
					var suelo = {
						nombre: "{{ s.nombre }}",
						valor: "{{ s.valor }}",
						etiqueta: "{{ s.etiqueta }}",					
					}
					suelos.push(suelo);			
				{% endfor %}			
			{% endfor %}			
		};	

		function calcularMargenBruto(){
			var dir = document.getElementsByName('dirEscenario')[0].value;
			var danios = document.getElementsByName('aEscenario');
			console.log(dir);
			var cookieEscenarios = ['escenariosMB', '=', JSON.stringify(escenarios),'; domain=', "127.0.0.1", '; path=/;'].join('');					
			document.cookie = cookieEscenarios;			
			var nombres = "";
			var anios = "";
			var noms  = "nombreEscenario=";						
			for (var n=0;n<escenarios.length;n++){
				if (n!==0){
					nombres = nombres + "&";
					anios = anios +"&";
				};
				nombres = nombres + noms + escenarios[n].nombre;
				anios = anios + "aEscenario=" + danios[n].value;
			};
			window.location.href = "http://127.0.0.1:8000/webapp/margenBruto?dirEscenario=" + dir + "&" + nombres + "&" + anios;	
		};
		
	</script>
	

	
</head>
<body>
	<div class="container">	

		<div class="page-header row">		
			<div class="col-xs-3"> 
				<img src="/static/img/logoSNIA.png" class="logo img-responsive">
			</div>		
			<div class="col-xs-6 text-center">
				<h2 style="color: #848688;"> Simulador de Cultivo </h2>
			</div>			
			<div class="col-xs-2 col-xs-offset-1">
				<ul class="nav">
					<li><a style="color: #848688;" href="http://snia.gub.uy/contacto-5/contacto-72?,,mnu-e-55-3-mnu-" target="_blank"><span class="glyphicon glyphicon-envelope"></span> Contacto</a></li>
				</ul>
			</div>			   
		</div>	
			
		<div class="paddingBottom">
			<div class="row paddingBottom">
				<div class="col-sm-6">
					<img class="img-responsive center-block" src="{{MEDIA_ROOT}}/{{dir}}/boxplot.png" alt="Rendimientos esperados (Boxplot)">
				</div>
				<div class="col-sm-6" id = "datosBoxplot">	
					<!--<h4>Box Plot o Cajas de Tukey</h4>-->
					<p>Este tipo de gráficos permite visualizar rápidamente los valores medios y la variabilidad esperada para un escenario planteado.</p>			
				</div>
			</div>	
			<div class="row paddingBottom">
				<div class="col-sm-6">
					<img class="img-responsive center-block" src="{{MEDIA_ROOT}}/{{dir}}/curvaPExcedencia.png" alt="Rendimientos esperados (Curva de probabilidad de exedencia)">
				</div>
				<div class="col-sm-6" id = "datosCurvaExedencia">	
					<!--<h4>Curva de excedencia</h4>-->
					<p>Este gráfico permite estimar la probabilidad de superar un determinado valor de rendimiento para diferentes escenarios.</p>			
				</div>
			</div>
		</div>
		
		<div>
			<div class="row">
				<h4> Escenarios agregados </h4>
			</div>
			<div class="row" id='escenario'>
				<div class="table-responsive">
					<table id="tEscenarios" class="table table-striped">
						<thead class="tabla_header">
						  <tr>
							<th>Escenario</th>
							<th>Cultivo</th>
							<th>Tipo de cultivar</th>
							<th>Riego</th>
							<th></th>
						  </tr>
						</thead>
						<tbody>
						</tbody>
					</table>	
				</div>			
			</div>		
		</div>
		
		<!--Parametros para pasar -->
		{% for anioE in aniosEscenarios %}
			<div id='aniosEscenario' style="display:none">
				<label for="aEscenario"> <b> Cantidad a&ntilde;os escenarios: </b> </label>
				<input type="text" name="aEscenario" class="form-control" id= "inAnioEscenario" value="{{ anioE }}" style="display:none">
			</div>
		{% endfor %}
		<input type="text" value="{{dir}}" name="dirEscenario" style="display:none">		
		

		<div class="row">				
			<input class="btn btn-success" type= "button" style="width:50%;margin:0px auto; display:block;" onclick='calcularMargenBruto()' name="margenBruto" value="Calcular margen bruto">
		</div>
		
		<div class="row margenTop">				
		</div>		
		
	</div>
	<script>
		cargarTSuelos();	
		cargarDatos();
		cargarParrafos();		
		cargarEscenarios();		
			
	</script>
</body>
</html>